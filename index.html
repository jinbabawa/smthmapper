<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>SMTH Mapper</title>

    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, target-densitydpi=device-dpi" />

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css"/>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js"></script>

    <script src="assets/PruneCluster.js"></script>
    <script src="assets/newsmth.js"></script>
    <link rel="stylesheet" href="assets/smthmapper.css"/>
  </head>
  <body>
    <div id="map"></div>
    <div id="buttons">
        ID: <select id="id-select">
            <option value="__all__">-- all --</option>
        </select>
        <input type="button" value="Apply" onClick="removeMarker();" />
    </div>

    <script>
      // cannot use dict as 'constructor' is not allowed as the key.
      var markers_dict = Object.create(null);
      var markers = []

      var map = L.map("map", {
          attributionControl: false,
          zoomControl: false
      }).setView(new L.LatLng(39.9288, 116.3889), 4);

      L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
          detectRetina: true,
          maxNativeZoom: 17
      }).addTo(map);

      var leafletView = new PruneClusterForLeaflet();

      var markers = [];

      for (var i = 0; i < newsmth.length; i++) {
        point = newsmth[i]

        var marker = new PruneCluster.Marker(ip_lon_lats[point[2]][1], ip_lon_lats[point[2]][0]);

        marker.data.popup = ids[point[0]] + '@' + ips[point[2]];

        markers.push(marker);
        leafletView.RegisterMarker(marker);

        id = ids[point[0]]

        if ( id in markers_dict ) {
            markers_dict[id].push(marker)
        } else {
            markers_dict[id] = [marker]
        }

        markers.push(marker);
      }

      var select = document.getElementById("id-select");
  
      sorted_key = [];
  
      for(var key in markers_dict) {
          sorted_key[sorted_key.length] = key;
      }
      
      sorted_key.sort();
  
      for (var i = 0; i < sorted_key.length; i++) {
          key = sorted_key[i];
          select.options[select.options.length] = new Option(key, key);
      }

      leafletView.ProcessView();

      map.addLayer(leafletView);

      function removeMarker() {
        select = document.getElementById("id-select");
        id = select.options[select.selectedIndex].value

        // window.alert(id)
        leafletView.RemoveMarkers();

        if (id == '__all__') {
            leafletView.RegisterMarkers(markers);
        } else {
            leafletView.RegisterMarkers(markers_dict[id]);
        }

        leafletView.ProcessView();
      }
  </script>
  </body>
</html>
